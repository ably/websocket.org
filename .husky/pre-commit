#!/bin/sh

# Set up PATH with common locations for tools
export PATH="/usr/local/bin:/opt/homebrew/bin:/opt/homebrew/opt/gnupg/bin:$PATH"

# Try to find node and npm in common locations
if ! command -v node >/dev/null 2>&1; then
  # Try common node installation paths
  export PATH="$HOME/.nvm/versions/node/*/bin:$PATH"

  # If still not found, try to source nvm
  if [ -f "$HOME/.nvm/nvm.sh" ]; then
    . "$HOME/.nvm/nvm.sh"
  fi
fi

# Ensure GPG is available for commit signing
if ! command -v gpg >/dev/null 2>&1; then
  # Try common GPG locations
  if [ -f "/opt/homebrew/bin/gpg" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
  elif [ -f "/usr/local/bin/gpg" ]; then
    export PATH="/usr/local/bin:$PATH"
  fi
fi

# Check if we have node/npm/npx available
if ! command -v npx >/dev/null 2>&1; then
  echo "‚ö†Ô∏è  Node.js/npm not found in PATH. Skipping pre-commit checks."
  echo "   To run checks manually, use: npm run lint && npm run format:check"
  exit 0
fi

# Run markdown linting on staged markdown files
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|mdx)$' || true)

if [ -n "$staged_files" ]; then
  echo "üîç Running markdown linter on staged files..."
  # Use the locally installed markdownlint-cli directly
  ./node_modules/.bin/markdownlint $staged_files

  if [ $? -ne 0 ]; then
    echo "‚ùå Markdown linting failed. Please fix the issues above."
    echo "üí° You can run 'npm run lint:fix' to auto-fix some issues."
    exit 1
  fi
fi

# Run prettier check on staged files
staged_code=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|astro|css|md|mdx)$' || true)

if [ -n "$staged_code" ]; then
  echo "üé® Checking code formatting..."
  ./node_modules/.bin/prettier --check $staged_code

  if [ $? -ne 0 ]; then
    echo "‚ùå Code formatting issues found. Please run 'npm run format' to fix."
    exit 1
  fi
fi

# Run TypeScript check (suppress warnings, only show errors)
echo "üìù Running TypeScript check..."

# Capture the output
ts_output=$(npm run astro check 2>&1)
ts_exit_code=$?

# Check if there are actual errors (not warnings or hints)
if echo "$ts_output" | grep -q " - error "; then
  echo "‚ùå TypeScript errors found. Please fix them before committing."
  echo "$ts_output" | grep -A2 " - error " | head -20
  exit 1
fi

# Silent success - no need to show warnings/hints
echo "  ‚úì No TypeScript errors"

echo "‚úÖ All pre-commit checks passed!"
